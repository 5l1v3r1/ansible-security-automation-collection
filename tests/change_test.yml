---
- hosts: localhost

  collections:
    - cyberark.bizdev

  tasks:

    - name: Logon to CyberArk Vault using PAS Web Services SDK
      cyberark_authentication:
        api_base_url: "http://components.cyberark.local"
        validate_certs: no
        username: "bizdev"
        password: "Cyberark1"


    - name: Debug message
      debug:
        var: cyberark_session


    - name: Account
      cyberark_account_modding:
        logging_level: "NOTSET"
        logging_file: "/tmp/james_test.log"
        identified_by: "address,username"
        safe: "Test"
        address: "10.0.1.20"
        username: "testestest"
        platform_id: WinServerLocal
        reset_credential: true
#        secret_management:
#            automatic_management_enabled: true
        state: present
        cyberark_session: "{{ cyberark_session }}"
      register: cyberarkaction
      
    - name: Debug message
      debug:
        var: cyberarkaction

    - name: Logoff from CyberArk Vault
      cyberark_authentication:
        state: absent
        cyberark_session: "{{ cyberark_session }}"

    - name: Debug message
      debug: var=cyberark_session
